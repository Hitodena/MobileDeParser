# ПОЛНАЯ ДОКУМЕНТАЦИЯ ПРОЕКТА MOBILEDE

## ОБЗОР ПРОЕКТА

**MobileDe Parser** - автоматизированная система парсинга автомобильных объявлений с сайта mobile.de через Telegram-бот.

### Ключевые возможности:
- Управление через Telegram
- Циклический автоматический парсинг
- Поддержка прокси с retry механизмом
- Автоматическая дедупликация данных
- Экспорт в различные форматы
- Опциональная AI-обработка текстов
- Асинхронная обработка запросов
- Детальное логирование

## АРХИТЕКТУРА СИСТЕМЫ

### Высокоуровневая архитектура

```
┌─────────────────────────────────────────────────────────────┐
│                    TELEGRAM BOT LAYER                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │Commands  │  │Handlers  │  │Middleware│  │Progress  │   │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘   │
└───────┼─────────────┼─────────────┼─────────────┼──────────┘
        │             │             │             │
        └─────────────┴─────────────┴─────────────┘
                        │
        ┌───────────────▼───────────────┐
        │    PARSER MANAGER LAYER       │
        │  ┌────────────────────────┐   │
        │  │   Parser Manager       │   │
        │  └───────────┬────────────┘   │
        └──────────────┼─────────────────┘
                       │
        ┌──────────────▼──────────────┐
        │   CORE SERVICES LAYER       │
        │  ┌────────┐  ┌────────┐    │
        │  │Scheduler│  │Parser  │    │
        │  │Service │  │Service │    │
        │  └────┬───┘  └───┬────┘    │
        └───────┼──────────┼──────────┘
                │          │
        ┌───────▼──────────▼──────────┐
        │   NETWORK LAYER             │
        │  ┌─────────┐  ┌──────────┐ │
        │  │HTTP     │  │Proxy     │ │
        │  │Client   │  │Manager   │ │
        │  └────┬────┘  └────┬─────┘ │
        └───────┼────────────┼────────┘
                │            │
        ┌───────▼────────────▼────────┐
        │   DATA LAYER                │
        │  ┌──────────┐  ┌─────────┐ │
        │  │Database  │  │Config   │ │
        │  │Service   │  │Service  │ │
        │  └──────────┘  └─────────┘ │
        └─────────────────────────────┘
                │
        ┌───────▼─────────┐
        │  SQLite Database │
        └──────────────────┘
```

### Поток данных

```
User → Telegram → Bot → ParserManager → Scheduler → Parser Service
                              ↓
                        HTTP Client
                              ↓
                        Proxy Manager
                              ↓
                          mobile.de
                              ↓
                        HTML Parser
                              ↓
                      Product Model
                              ↓
                      Database Service
                              ↓
                        SQLite DB
```

---

## СТРУКТУРА ПРОЕКТА

```
MobileDe/
├── bot/                        # Telegram-бот
│   ├── handlers/                  # Обработчики команд
│   │   └── commands.py           # Все команды бота
│   ├── middleware/                # Промежуточное ПО
│   │   └── middleware.py         # Авторизация пользователей
│   ├── models/                    # Модели бота
│   │   ├── bot_config.py         # Конфигурация бота
│   │   ├── parser_status.py      # Статус парсера
│   │   ├── parsing_progress.py   # Прогресс парсинга
│   │   └── parsing_result.py     # Результаты парсинга
│   ├── services/                  # Сервисы бота
│   │   ├── parser_manager.py     # Управление парсером
│   │   └── progress_tracker.py   # Отслеживание прогресса
│   ├── utils/                     # Утилиты бота
│   │   └── lifecycle.py          # Lifecycle управление
│   └── bot.py                     # Основной класс бота
│
├── core/                       # Ядро системы
│   ├── models/                    # Модели данных
│   │   └── product_model.py      # Модель товара
│   ├── parsers/                   # Парсеры
│   │   ├── base_parser.py        # Базовый парсер
│   │   └── mobilede_ru_parser.py # Парсер mobile.de
│   └── services/                  # Основные сервисы
│       ├── parser_service.py     # Сервис парсинга
│       └── scheduler_service.py  # Планировщик задач
│
├── shared/                     # Общие компоненты
│   ├── config/                    # Конфигурация
│   │   ├── config.py             # Загрузка конфигурации
│   │   └── config_model.py       # Модель конфигурации
│   ├── exceptions/                # Исключения
│   │   ├── html_exceptions.py    # HTML исключения
│   │   ├── model_exceptions.py   # Модель исключения
│   │   └── request_exceptions.py # HTTP исключения
│   ├── models/                    # Модели БД
│   │   └── database_model.py     # SQLAlchemy модели
│   ├── services/                  # Общие сервисы
│   │   ├── database_service.py   # Работа с БД
│   │   ├── http_client.py        # HTTP клиент
│   │   ├── logger.py             # Настройка логгера
│   │   └── openrouter_service.py # AI сервис
│   └── utils/                     # Утилиты
│       ├── generate_headers.py   # Генерация заголовков
│       ├── generate_links.py     # Генерация ссылок
│       ├── html_parser.py        # HTML утилиты
│       ├── proxy_manager.py      # Управление прокси
│       └── storage_management.py # Управление хранилищем
│
├── var/www/mobile/             # Данные проекта
│   ├── files/                     # Файлы
│   │   └── products.db           # База данных
│   ├── excludes_brand.csv        # Исключаемые бренды
│   ├── excludes_dealer.csv       # Исключаемые дилеры
│   ├── excludes_images.csv       # Правила по изображениям
│   └── replaces.csv              # Правила замены текста
│
├── logs/                       # Логи системы
├── docker/                     # Docker конфигурация
├── scripts/                    # Скрипты запуска
│   ├── setup.sh                  # Установка
│   └── watchdog.sh               # Мониторинг
│
├── configuration.yaml          # Главная конфигурация
├── proxies.txt                # Список прокси
├── prompt.txt                 # Промпт для AI
├── main.py                    # Точка входа
├── pyproject.toml             # Зависимости
└── README.md                  # Документация
```

---

## 🔧 ОСНОВНЫЕ КОМПОНЕНТЫ

### 1. Telegram Bot (`bot/`)

**Назначение:** Интерфейс управления системой через Telegram

**Основные классы:**
- `TelegramBot` - главный класс бота
- `CommandHandlers` - обработчики команд
- `AuthMiddleware` - авторизация пользователей
- `ParserManager` - управление процессом парсинга
- `ProgressTracker` - отслеживание прогресса

**Команды:**
- `/start` - запуск парсинга
- `/stop` - остановка парсинга
- `/status` - статус системы
- `/seturl` - установка URL
- `/dbstats` - статистика БД
- `/sqldump` - SQL дамп
- `/exportdb` - экспорт данных
- `/cleardb` - очистка БД
- `/help` - справка

### 2. Core Services (`core/`)

#### ParserService
Основной сервис парсинга данных.

**Функции:**
- Управление HTTP запросами
- Парсинг ссылок (batch обработка)
- Парсинг карточек товаров
- Фильтрация по существующим SKU
- Сохранение в БД
- AI-обработка (опционально)

#### SchedulerService
Планировщик циклического парсинга.

**Функции:**
- Циклический запуск парсинга
- Управление интервалами
- Обработка ошибок
- Callback уведомления

**Ключевые методы:**
- Запуск циклического парсинга
- Выполнение одного цикла
- Остановка планировщика

### 3. Network Layer (`shared/`)

#### HTTPClient
Асинхронный HTTP клиент с retry логикой.

**Особенности:**
- Автоматические повторные попытки (3 попытки)
- Поддержка прокси
- Динамическая генерация заголовков
- Обработка таймаутов
- Экспоненциальная задержка при ретраях

**Ключевые методы:**
- Получение содержимого страницы
- Отправка JSON данных (для AI)

#### ProxyManager
Управление прокси-серверами с retry механизмом.

**Особенности:**
- **Retry механизм**: 3 попытки × 10 минут
- Параллельная валидация прокси
- Автоматическое исключение неработающих
- Ротация прокси (random + round-robin)
- Lazy loading при нехватке

### 4. Database Layer (`shared/services/`)

#### DatabaseService
Singleton сервис для работы с SQLite.

**Функции:**
- CRUD операции
- Автоматическая дедупликация по SKU
- Batch сохранение
- Фильтрация по изображениям
- SQL дампы
- AI маркировка

**Ключевые методы:**
- Сохранение одного товара
- Пакетное сохранение товаров
- Получение всех товаров (с опцией фильтрации по AI маркеру)
- Получение всех существующих SKU
- Обновление поля товара
- Очистка базы данных

### 5. Parsers (`core/parsers/`)
- Парсинг списка ссылок на товары
- Парсинг данных одного товара

## ТЕХНОЛОГИЧЕСКИЙ СТЕК

### Backend
- **Python 3.12+** - основной язык
- **asyncio** - асинхронность
- **aiohttp 3.12+** - HTTP запросы
- **aiogram 3.0+** - Telegram Bot API
- **SQLAlchemy 2.0+** - ORM
- **BeautifulSoup4** - парсинг HTML
- **Pydantic 2.11+** - валидация данных
- **Loguru 0.7+** - логирование
- **PyYAML 6.0+** - конфигурация

### База данных
- **SQLite** - основное хранилище

### Инфраструктура
- **Docker** - контейнеризация
- **uv** - менеджер пакетов

## КОНФИГУРАЦИЯ

### Структура configuration.yaml

```yaml
# ЛОГИРОВАНИЕ
logging:
  level: INFO                    # Уровень логов
  log_dir: logs                  # Директория логов
  rotation: "10 MB"              # Ротация
  retention: "30 days"           # Хранение
  compression: zip               # Сжатие

# ПАРСЕР
parser:
  base_url: "https://www.mobile.de/"
  base_search_url: "..."         # URL для парсинга
  pages: 40                      # Количество страниц
  items_per_page: 50             # Товаров на странице
  timeout: 15                    # Таймаут запросов (сек)
  retries: 3                     # Попытки при ошибках
  delay_min: 0.1                 # Мин задержка (сек)
  delay_max: 0.5                 # Макс задержка (сек)
  max_concurrency: 5             # Макс параллельных запросов
  exclude_ads_pictures: -1       # Фильтр по кол-ву фото (-1 = выкл)

  # ПРОКСИ
  proxy_file: proxies.txt
  proxy_timeout: 5               # Таймаут прокси
  proxy_check_retries: 3         # ⭐ Попытки валидации
  proxy_check_interval: 600      # ⭐ Интервал между попытками (10 мин)

  # ЦИКЛЫ
  interval_between_parse: 1800   # Интервал между циклами (30 мин)
  cycle: true                    # Циклический режим

# AI ОБРАБОТКА
ai:
  enabled: true                  # Включить AI
  api_key: "sk-..."              # OpenRouter API ключ
  model: "openrouter/polaris-alpha"
  timeout: 600                   # Таймаут AI запросов
  batch_count: 100               # Товаров в одном запросе

# ФАЙЛЫ
files:
  brand_excludes_file: "/var/www/mobile/excludes_brand.csv"
  dealer_excludes_file: "/var/www/mobile/excludes_dealer.csv"
  replaces_file: "/var/www/mobile/replaces.csv"
  db_path: "sqlite:///var/www/mobile/files/products.db"
  db_table_name: "products"

# ШАБЛОНЫ
templates:
  title: "{category} {model} {year}"
  seo_title: "Купить {category} {model} {year} - Лучшая цена"
  seo_description: "..."
  seo_keywords: "{category}, {model}, {year}"

# РАСЧЕТЫ
calculation:
  currency_exchange: 0.24        # Курс EUR → RUB

# API
api:
  telegram: "YOUR_TOKEN"
  tg_users: [123456789]

# БАЗА ДАННЫХ (названия полей)
database:
  title: "Title"
  category: "Category"
  model: "Characteristics: модель"
  # ... другие поля
```

### Конфигурационные CSV файлы

#### excludes_brand.csv
Исключение брендов из парсинга:
```csv
brand
BMW
Mercedes-Benz
Audi
```

#### excludes_dealer.csv
Исключение дилеров:
```csv
dealer_url
https://home.mobile.de/home/redirect.html?seller=12345
```

#### replaces.csv
Правила замены текста:
```csv
old,new
"Benzin","Бензин"
"Diesel","Дизель"
"Automatik","Автомат"
```

---

## API И КОМАНДЫ

### Telegram команды

#### `/start`
Запускает процесс парсинга.

**Поведение:**
1. Проверка активных задач
2. Валидация URL
3. Инициализация progress tracker
4. Запуск циклического парсинга

**Ответ:**
```
• Парсинг запущен
```

#### `/stop`
Останавливает парсинг.

**Ответ:**
```
• Парсинг остановлен
```

#### `/status`
Показывает текущий статус системы.

**Ответ:**
```
• Статус парсера:
• Работает: Да
• Интервал: 1800 сек
• Цикл: Включен
• Макс. потоков: 5
```

#### `/seturl`
Устанавливает URL для парсинга.

**Использование:**
1. Отправить `/seturl`
2. Отправить URL: `https://mobile.de/ru/...`

#### `/dbstats`
Статистика базы данных.

**Ответ:**
```
• Статистика базы данных:
• Всего продуктов: 1,234
• Путь к БД: /var/www/mobile/files/products.db
```

#### `/exportdb`
Экспортирует данные из БД в архив.

**Результат:**
- Архив с CSV файлом
- Все продукты из БД

#### `/cleardb`
Полная очистка базы данных.

## ОБРАБОТКА ОШИБОК

### Типы исключений

#### RequestException
Базовое исключение для обработки HTTP ошибок и сетевых проблем.

**Обработка:**
- Автоматические retry (3 попытки)
- Экспоненциальная задержка
- Смена прокси при ошибке

#### OutOfProxiesException
Специальное исключение, генерируемое когда не осталось рабочих прокси-серверов.

**Обработка:**
- Retry механизм (3 × 10 мин)
- Уведомление пользователя
- Остановка парсинга

#### HTMLParsingException
Исключение для ошибок при парсинге HTML структуры страниц.

**Обработка:**
- Логирование с контекстом
- Пропуск проблемной страницы
- Продолжение работы

## ЛОГИРОВАНИЕ

### Структура логов

Логи содержат структурированную информацию с контекстом: название сервиса, URL запроса, номер попытки, используемый прокси и user-agent.

### Уровни логирования

- **DEBUG** - детальная отладка (HTTP запросы, прокси)
- **INFO** - основная информация (старт/стоп, прогресс)
- **WARNING** - предупреждения (пропуск товара, retry)
- **ERROR** - ошибки (HTTP ошибки, парсинг)
- **CRITICAL** - критические ошибки (остановка системы)

### Модули логирования

```
Main                 - Главный модуль
TelegramBot          - Telegram бот
ParserManager        - Менеджер парсера
SchedulerService     - Планировщик
ParserService        - Сервис парсинга
HTTPClient           - HTTP клиент
ProxyManager         - Менеджер прокси
DatabaseService      - Сервис БД
MobileDeRuParser     - Парсер
```

### Ротация логов

- Файл лога ротируется при достижении 10 MB
- Логи хранятся 30 дней
- Старые логи автоматически сжимаются в ZIP архивы

## БАЗА ДАННЫХ

### Схема БД

Таблица products содержит следующие поля:
- **id** - уникальный идентификатор (автоинкремент)
- **Основные характеристики:** title, category, model, year_of_release, mileage, transmission, fuel, engine_volume, power
- **Дополнительные характеристики:** body, color, door_count, seat_count, owner_count
- **Коммерческая информация:** price, text, images, url, dealer
- **SKU** - уникальный артикул товара (индексируется)
- **SEO поля:** seo_title, seo_description, seo_keywords, seo_alt
- **Вкладки:** tab_one, tab_two
- **Служебные:** marked_for_ai (маркер для AI обработки), created_at, updated_at (временные метки)

Создаются индексы по полям sku А created_at для оптимизации запросов.

## БЕЗОПАСНОСТЬ

### Авторизация

#### Telegram Middleware
Middleware проверяет ID пользователя перед обработкой каждого запроса. Если ID пользователя не находится в списке разрешенных - доступ блокируется с соответствующим сообщением.

### Прокси

#### Формат прокси
Прокси указываются в формате: IP-адрес:порт:имя_пользователя:пароль

#### Безопасность прокси
- Проверка работоспособности
- Таймауты (5 сек)
- Автоматическое исключение неработающих
- Retry механизм при сбоях

### Данные

#### Конфиденциальность
- Токены в конфигурации (не в коде)
- `.gitignore` для чувствительных файлов
- Логи без паролей

#### Валидация
- Pydantic модели
- Проверка URL
- Санитизация HTML

---

## ОСОБЕННОСТИ РЕАЛИЗАЦИИ

### Batch Processing

**Цель:** Оптимизация производительности.

**Реализация:**
URL разбиваются на батчи по максимальному количеству одновременных запросов (по умолчанию 5). Каждый батч обрабатывается параллельно с помощью асинхронного сбора результатов, что значительно ускоряет процесс парсинга.

### SKU-Based Deduplication

**Цель:** Избежать повторного парсинга.

**Реализация:**
Перед парсингом система получает из базы данных все существующие SKU товаров. Затем для каждой найденной ссылки извлекается SKU и проверяется его наличие в базе. Ссылки с уже существующими SKU исключаются из обработки, что экономит ресурсы и время.

**Преимущества:**
- Экономия трафика
- Ускорение парсинга
- Снижение нагрузки на прокси

## МОНИТОРИНГ И ОТЛАДКА

### Статистика парсинга

```
• Парсинг завершен: 5
• Найдено товаров: 1234
• Новых сохранено: 567
• Всего товаров в БД: 5,678
• Рабочие прокси: 15/100
```

### Telegram уведомления

- Старт/завершение цикла
- Количество найденных товаров
- Ошибки парсинга
- Статус прокси

---

## LIFECYCLE УПРАВЛЕНИЕ

### Запуск системы

```
1. Загрузка конфигурации
2. Инициализация логгера
3. Создание Telegram бота
4. Инициализация ParserManager
5. Валидация прокси (с retry)
6. Запуск polling
7. Готовность к командам
```
