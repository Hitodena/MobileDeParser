# ТЕХНИЧЕСКИЙ МАНУАЛ ПО ПРОЕКТУ MOBILEDE

## ОБЩЕЕ ОПИСАНИЕ

Проект MobileDe представляет собой автоматизированную систему парсинга автомобильных объявлений с сайта mobile.de. Система состоит из Telegram-бота для управления и веб-парсера для сбора данных.

## АРХИТЕКТУРА СИСТЕМЫ

### Основные компоненты:
- **Telegram Bot** - интерфейс управления парсером
- **Parser Service** - сервис парсинга веб-страниц
- **Database Service** - управление базой данных SQLite
- **HTTP Client** - HTTP-клиент с поддержкой прокси
- **Proxy Manager** - управление прокси-серверами
- **Scheduler Service** - планировщик задач

### Технологический стек:
- Python 3.12+
- aiogram 3.0+ (Telegram Bot API)
- SQLAlchemy 2.0+ (ORM для базы данных)
- aiohttp (асинхронные HTTP-запросы)
- BeautifulSoup4 (парсинг HTML)
- Pydantic (валидация данных)
- Loguru (логирование)

## ФУНКЦИОНАЛЬНОСТЬ

### Команды Telegram-бота:

#### Основные команды:
- `/start` - запуск парсинга
- `/stop` - остановка парсинга
- `/status` - статус парсера
- `/help` - справка по командам

#### Управление данными:
- `/seturl` - установка ссылки для парсинга
- `/dbstats` - статистика базы данных
- `/sqldump` - создание SQL-дампа
- `/exportdb` - экспорт данных в архив
- `/cleardb` - очистка базы данных

### Парсинг данных:
- Автоматический сбор автомобильных объявлений
- Фильтрация по количеству изображений
- Исключение брендов и дилеров
- Замена текста по правилам
- Форматирование данных по шаблонам

## КОНФИГУРАЦИЯ

### Основные параметры (configuration.yaml):

#### Парсер:
- `base_url` - базовый URL сайта
- `pages` - количество страниц для парсинга
- `items_per_page` - товаров на странице
- `timeout` - таймаут запросов (15 сек)
- `retries` - количество повторных попыток (3)
- `delay_min/max` - задержки между запросами (1-2 сек)
- `max_concurrency` - максимальная параллельность (5)
- `interval_between_parse` - интервал между циклами (3600 сек)

#### Файлы:
- `brand_excludes_file` - исключаемые бренды
- `dealer_excludes_file` - исключаемые дилеры
- `dealer_exclude_images_file` - правила исключения изображений
- `replaces_file` - правила замены текста
- `db_path` - путь к базе данных

#### Шаблоны:
- `title` - шаблон заголовка товара
- `seo_title` - SEO-заголовок
- `seo_description` - SEO-описание
- `seo_keywords` - ключевые слова

## СТРУКТУРА ПРОЕКТА

```
MobileDe/
├── bot/                    # Telegram-бот
│   ├── handlers/          # Обработчики команд
│   ├── middleware/        # Промежуточное ПО
│   ├── models/           # Модели бота
│   ├── services/         # Сервисы бота
│   └── utils/            # Утилиты
├── core/                  # Основная логика
│   ├── models/           # Модели данных
│   ├── parsers/          # Парсеры
│   └── services/         # Основные сервисы
├── shared/                # Общие компоненты
│   ├── config/           # Конфигурация
│   ├── services/         # Общие сервисы
│   └── utils/            # Общие утилиты
├── var/www/mobile/        # Данные и файлы
│   ├── files/            # Файлы проекта
│   └── *.csv             # Конфигурационные CSV
└── logs/                  # Логи системы
```

## УПРАВЛЕНИЕ СИСТЕМОЙ

### Запуск:
```bash
cd scripts
chmod +x ./setup.sh
./setup.sh
```

### Мониторинг:
- Логи сохраняются в директории `logs/`
- Ротация логов: 10 MB, хранение 30 дней
- Сжатие старых логов в ZIP

### База данных:
- SQLite база в `var/www/mobile/files/products.db`
- Автоматическая фильтрация дублей
- Возможность экспорта и очистки

## БЕЗОПАСНОСТЬ И ОГРАНИЧЕНИЯ

### Прокси-серверы:
- Поддержка файла `proxies.txt`
- Автоматическая проверка работоспособности
- Таймаут для прокси: 10 секунд

### Ограничения запросов:
- Максимум 5 одновременных запросов
- Задержки между запросами: 1-2 секунды
- Таймаут запросов: 15 секунд

### Фильтрация:
- Исключение объявлений по количеству изображений
- Фильтрация по брендам и дилерам
- Правила замены текста

## ЭКСПОРТ ДАННЫХ

### Форматы экспорта:
- SQL-дамп базы данных
- Архив с данными в CSV-формате
- Автоматическое создание временных меток

### Структура экспорта:
- Заголовки товаров по шаблонам
- SEO-метаданные
- Информация о ценах и характеристиках
- Фильтрация по заданным правилам

## ТЕХНИЧЕСКИЕ ТРЕБОВАНИЯ

### Системные требования:
- Python 3.12 или выше
- Минимум 2 GB RAM
- Стабильное интернет-соединение
- Доступ к прокси-серверам

### Зависимости:
- Все зависимости указаны в `pyproject.toml`
- Управление пакетами через `uv` внутри контейнера
- Автоматическая установка зависимостей

## ЛОГИРОВАНИЕ И МОНИТОРИНГ

### Уровни логирования:
- INFO - основная информация
- DEBUG - детальная отладка
- ERROR - ошибки и исключения

### Модули логирования:
- Парсер-сервис
- Планировщик задач
- HTTP-клиент
- Менеджер прокси
- Telegram-бот

## ПОДДЕРЖКА И ОБСЛУЖИВАНИЕ

### Регулярные задачи:
- Проверка работоспособности прокси
- Ротация логов
- Очистка временных файлов
- Мониторинг состояния базы данных

### Устранение неполадок:
- Проверка логов в директории `logs/`
- Валидация конфигурации
- Тестирование прокси-серверов
- Проверка доступности target-сайта

## ОГРАНИЧЕНИЯ И РИСКИ

### Технические ограничения:
- Зависимость от доступности mobile.de
- Необходимость актуальных прокси-серверов
- Ограничения по скорости парсинга
- Возможность блокировки IP-адресов

### Рекомендации:
- Регулярное обновление прокси-листов
- Мониторинг логов на предмет ошибок
- Резервное копирование базы данных
- Тестирование после изменений конфигурации
